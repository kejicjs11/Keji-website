<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Listings | AbrakaHomes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">

<style>
  body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; }
  .navbar { background: #007bff; color: #fff; padding: 10px 20px; display: flex; justify-content: space-between; flex-wrap: wrap; }
  .navbar h1 a { color: #fff; text-decoration: none; }
  .navbar nav a { color: #fff; margin-left: 15px; text-decoration: none; font-weight: bold; }
  .page-content { padding: 20px; max-width: 1200px; margin: auto; }
  .filters { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
  .filters select { padding: 8px; border-radius: 6px; border: 1px solid #ccc; }
  .listings-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
  .hostel-card { background: #fff; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 300px; overflow: hidden; display: flex; flex-direction: column; }
  .hostel-card img { width: 100%; height: 200px; object-fit: cover; }
  .hostel-content { padding: 15px; display: flex; flex-direction: column; gap: 5px; }
  .hostel-title { font-weight: bold; font-size: 18px; }
  .hostel-category, .hostel-price, .hostel-status { font-size: 14px; color: #555; }
  .hostel-description { font-size: 14px; color: #333; margin-top: 5px; }
  button { margin-top: 5px; border: none; padding: 7px 10px; border-radius: 5px; cursor: pointer; }
  .delete-btn { background-color: #ff4d4f; color: #fff; }
  .taken-btn { background-color: #6c757d; color: #fff; }
  .chat-btn { background-color: #28a745; color: #fff; }
  .agent-btn { background-color: #007bff; color: #fff; }
  .whatsapp-btn { background-color: #25D366; color: #fff; }
  footer { text-align: center; padding: 15px; background: #007bff; color: #fff; margin-top: 40px; }
</style>
</head>

<body>

<header class="navbar">
  <h1><a href="index.html">AbrakaHomes</a></h1>
  <nav>
    <a href="hostel-map.html">Hostel Map</a>
    <a href="marketplace.html">Marketplace</a>
    <a href="listings.html">Listings</a>
    <a href="agents.html">Agents</a>
    <a href="login.html">Login</a>
  </nav>
</header>

<main class="page-content">
  <h2>Available Listings</h2>

  <div class="filters">
    <select id="typeFilter">
      <option value="">All Types</option>
      <option>One-room</option>
      <option>Self-contained</option>
      <option>Duplex</option>
      <option>Mini-flat</option>
      <option>Others</option>
    </select>

    <select id="locationFilter">
      <option value="">All Locations</option>
      <option>Abraka Market Road</option>
      <option>Ekrejeta Area</option>
    </select>

    <select id="priceFilter">
      <option value="">All Prices</option>
      <option value="0-150000">₦0 - ₦150,000</option>
      <option value="150001-250000">₦150,001 - ₦250,000</option>
      <option value="250001-500000">₦250,001 - ₦500,000</option>
    </select>
  </div>

  <div id="listings-container" class="listings-container"></div>
  <div id="message"></div>
</main>

<footer>
  <p>© 2025 AbrakaHomes</p>
</footer>

<script>
let currentUser = null;

/* ===== AUTH ===== */
async function loadCurrentUser() {
  const token = localStorage.getItem("authToken");
  if (!token) return null;

  const res = await fetch("/api/me", {
    headers: { Authorization: token }
  });

  if (!res.ok) return null;
  return res.json();
}

/* ===== FETCH HOSTELS ===== */
async function fetchHostels() {
  const res = await fetch("/api/hostels");
  if (!res.ok) return [];
  return res.json();
}

/* ===== FILTER ===== */
function applyFilters(list) {
  const type = typeFilter.value;
  const location = locationFilter.value;
  const price = priceFilter.value;

  return list.filter(h => {
    if (type && h.category !== type) return false;
    if (location && h.location !== location) return false;
    if (price) {
      const [min, max] = price.split("-").map(Number);
      if (h.price < min || h.price > max) return false;
    }
    return true;
  });
}

/* ===== RENDER ===== */
async function renderListings() {
  const container = document.getElementById("listings-container");
  container.innerHTML = "Loading...";

  let hostels = await fetchHostels();
  hostels = applyFilters(hostels);

  if (!hostels.length) {
    container.innerHTML = "No listings found.";
    return;
  }

  container.innerHTML = "";

  hostels.forEach(h => {
    const card = document.createElement("div");
    card.className = "hostel-card";

    card.innerHTML = `
      <img src="${h.images?.[0] || 'placeholder.jpg'}">
      <div class="hostel-content">
        <div class="hostel-title">${h.name}</div>
        <div class="hostel-category">Category: ${h.category}</div>
        <div class="hostel-price">Price: ₦${h.price}</div>
        <div class="hostel-status">Status: ${h.taken ? "Taken" : "Available"}</div>
        <div class="hostel-description">${h.description}</div>
      </div>
    `;

    const content = card.querySelector(".hostel-content");

    if (currentUser?.role === "admin") {
      const del = document.createElement("button");
      del.className = "delete-btn";
      del.textContent = "Delete";
      del.onclick = async () => {
        if (!confirm("Delete this listing?")) return;
        await fetch(`/api/hostels?id=${h._id}`, {
          method: "DELETE",
          headers: { Authorization: localStorage.getItem("authToken") }
        });
        renderListings();
      };
      content.appendChild(del);
    }

    if (currentUser?.id === h.ownerId && !h.taken) {
      const taken = document.createElement("button");
      taken.className = "taken-btn";
      taken.textContent = "Mark Taken";
      taken.onclick = async () => {
        await fetch("/api/hostels/taken", {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            Authorization: localStorage.getItem("authToken")
          },
          body: JSON.stringify({ id: h._id })
        });
        renderListings();
      };
      content.appendChild(taken);
    }

    content.innerHTML += `
      <button class="chat-btn">Chat</button>
      <button class="agent-btn">View Agent</button>
      <button class="whatsapp-btn"
        onclick="window.open('https://wa.me/?text=Only%20for%20emergencies')">
        WhatsApp
      </button>
    `;

    container.appendChild(card);
  });
}

/* ===== INIT ===== */
window.addEventListener("DOMContentLoaded", async () => {
  currentUser = await loadCurrentUser();
  renderListings();

  typeFilter.onchange = renderListings;
  locationFilter.onchange = renderListings;
  priceFilter.onchange = renderListings;
});
</script>

</body>
</html>
