<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Listings | AbrakaHomes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">

<style>
/* ===== DARK MODE ===== */
body {
  font-family: Arial, sans-serif;
  background: #0e0e0e;
  color: #eaeaea;
  margin: 0;
}

.navbar {
  background: #121212;
  color: #fff;
  padding: 12px 20px;
  display: flex;
  justify-content: space-between;
  flex-wrap: wrap;
  border-bottom: 1px solid #222;
}

.navbar h1 a {
  color: #fff;
  text-decoration: none;
}

.navbar nav a {
  color: #bbb;
  margin-left: 15px;
  text-decoration: none;
  font-weight: bold;
}

.navbar nav a:hover {
  color: #fff;
}

.page-content {
  padding: 20px;
  max-width: 1200px;
  margin: auto;
}

.filters {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.filters select {
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #333;
  background: #1a1a1a;
  color: #fff;
}

#listings-container {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  justify-content: center;
}

.hostel-card {
  background: #151515;
  border-radius: 12px;
  width: 320px;
  overflow: hidden;
  border: 1px solid #222;
  display: flex;
  flex-direction: column;
}

.hostel-card img {
  width: 100%;
  height: 200px;
  object-fit: cover;
}

.hostel-content {
  padding: 15px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.hostel-title {
  font-size: 18px;
  font-weight: bold;
}

.hostel-meta {
  font-size: 13px;
  color: #aaa;
}

.hostel-description {
  font-size: 14px;
  color: #ddd;
  margin-top: 5px;
}

.listing-actions button {
  margin-top: 6px;
  border: none;
  padding: 7px 10px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
}

.delete-btn { background: #ff4d4f; color: #fff; }
.taken-btn { background: #444; color: #fff; }
.chat-btn { background: #28a745; color: #fff; }
.agent-btn { background: #0066ff; color: #fff; }
.whatsapp-btn { background: #25D366; color: #000; }

footer {
  text-align: center;
  padding: 15px;
  background: #121212;
  color: #aaa;
  margin-top: 40px;
  border-top: 1px solid #222;
}
</style>
</head>

<body>

<header class="navbar">
  <h1><a href="index.html">AbrakaHomes</a></h1>
  <nav>
    <a href="hostel-map.html">Hostel Map</a>
    <a href="marketplace.html">Marketplace</a>
    <a href="listings.html">Listings</a>
    <a href="agents.html">Agents</a>
    <a href="login.html">Login</a>
  </nav>
</header>

<main class="page-content">
  <h2>Available Listings</h2>

  <div class="filters">
    <select id="typeFilter">
      <option value="">All Types</option>
      <option value="One-room">One-room</option>
      <option value="Self-contained">Self-contained</option>
      <option value="Duplex">Duplex</option>
      <option value="Mini-flat">Mini-flat</option>
      <option value="Others">Others</option>
    </select>

    <select id="locationFilter">
      <option value="">All Locations</option>
      <option value="Abraka Market Road">Abraka Market Road</option>
      <option value="Ekrejeta Area">Ekrejeta Area</option>
    </select>

    <select id="priceFilter">
      <option value="">All Prices</option>
      <option value="0-150000">₦0 - ₦150,000</option>
      <option value="150001-250000">₦150,001 - ₦250,000</option>
      <option value="250001-500000">₦250,001 - ₦500,000</option>
    </select>
  </div>

  <div id="listings-container"></div>
  <div id="message"></div>
</main>

<footer>
  <p>© 2025 AbrakaHomes</p>
</footer>

<script>
/* ========= CONFIG ========= */
const API_URL = "/api/hostels";
let currentUser = null;

/* ========= AUTH ========= */
async function fetchCurrentUser() {
  const token = localStorage.getItem("authToken");
  if (!token) return null;

  const res = await fetch("/api/me", {
    headers: { Authorization: token }
  });

  return res.ok ? res.json() : null;
}

/* ========= DATA ========= */
async function fetchHostels() {
  const res = await fetch(API_URL);
  return res.ok ? res.json() : [];
}

/* ========= FILTER ========= */
function applyFilters(hostels) {
  const type = typeFilter.value;
  const location = locationFilter.value;
  const price = priceFilter.value;

  return hostels.filter(h => {
    if (type && h.category !== type) return false;
    if (location && h.location !== location) return false;
    if (price) {
      const [min, max] = price.split("-").map(Number);
      if (h.price < min || h.price > max) return false;
    }
    return true;
  });
}

/* ========= RENDER ========= */
async function renderHostels() {
  const container = document.getElementById("listings-container");
  container.innerHTML = "Loading...";

  let hostels = applyFilters(await fetchHostels());
  container.innerHTML = "";

  if (!hostels.length) {
    container.innerHTML = "No listings found.";
    return;
  }

  hostels.forEach(h => {
    const card = document.createElement("div");
    card.className = "hostel-card";

    card.innerHTML = `
      <img src="${h.images?.[0] || 'placeholder.jpg'}">
      <div class="hostel-content">
        <div class="hostel-title">${h.name}</div>
        <div class="hostel-meta">${h.category} • ₦${h.price}</div>
        <div class="hostel-meta">Status: ${h.taken ? "Taken" : "Available"}</div>
        <div class="hostel-description">${h.description}</div>

        <div class="listing-actions">
          ${currentUser?.role === "admin" ? `<button class="delete-btn" onclick="deleteListing('${h._id}')">Delete</button>` : ""}
          ${currentUser?.id === h.ownerId && !h.taken ? `<button class="taken-btn" onclick="markTaken('${h._id}')">Mark Taken</button>` : ""}
          <button class="chat-btn">Chat</button>
          <button class="agent-btn">View Agent</button>
          <button class="whatsapp-btn" onclick="openWhatsApp()">WhatsApp</button>
        </div>
      </div>
    `;

    container.appendChild(card);
  });
}

/* ========= ACTIONS ========= */
async function deleteListing(id) {
  if (!confirm("Delete this listing?")) return;
  const token = localStorage.getItem("authToken");

  await fetch(`${API_URL}?id=${id}`, {
    method: "DELETE",
    headers: { Authorization: token }
  });

  renderHostels();
}

async function markTaken(id) {
  const token = localStorage.getItem("authToken");

  await fetch("/api/hostels/taken", {
    method: "PATCH",
    headers: {
      "Content-Type": "application/json",
      Authorization: token
    },
    body: JSON.stringify({ id })
  });

  renderHostels();
}

function openWhatsApp() {
  window.open("https://wa.me/?text=Only%20for%20emergencies", "_blank");
}

/* ========= INIT ========= */
document.addEventListener("DOMContentLoaded", async () => {
  currentUser = await fetchCurrentUser();
  renderHostels();

  typeFilter.onchange = renderHostels;
  locationFilter.onchange = renderHostels;
  priceFilter.onchange = renderHostels;
});
</script>

</body>
        </html>
